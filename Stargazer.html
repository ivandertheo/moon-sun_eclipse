<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gerhana 3D — Realistic Umbra & Penumbra</title>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden; }
    canvas { display: block; }

    #topControls {
      position: fixed;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 1000;
    }

    #topControls button {
      padding: 8px 16px;
      font-weight: bold;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #1e88ff;
      color: white;
    }

    #ui {
      position: fixed;
      top: 80px;
      left: 20px;
      padding: 15px;
      background: rgba(0,0,0,0.55);
      color: #fff;
      border-radius: 10px;
      width: 240px;
      z-index: 999;
      font-family: Arial;
      backdrop-filter: blur(4px);
    }

    #ui label {
      margin-top: 12px;
      display: block;
      font-weight: 600;
    }

    #ui input { width: 100%; }

  </style>

  <!-- IMPORT MAP -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
    }
  }
  </script>
</head>

<body>

<!-- TOP CENTER CONTROLS -->
<div id="topControls">
  <button id="btnReverse">⏪ Reverse</button>
  <button id="btnStop">⏸ Stop</button>
  <button id="btnPlay">▶ Play</button>
</div>

<!-- UI SLIDERS -->
<div id="ui">
  <div style="font-weight:600; font-size:16px;">Gerhana — Three.js</div>

  <label>Orbital angle (°): <span id="angleVal">0</span></label>
  <input id="angle" type="range" min="-30" max="30" step="0.1" value="0">

  <label>Moon distance: <span id="distVal">2.0</span></label>
  <input id="moonDist" type="range" min="1.3" max="3.2" step="0.01" value="2.0">

  <label>Speed: <span id="speedVal">1</span></label>
  <input id="speed" type="range" min="0" max="2" step="0.01" value="1">

  <button id="reset">Reset</button>
</div>



<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";

/* === SCENE SETUP === */
const scene = new THREE.Scene();

const camera = new THREE.PerspectiveCamera(
  65,
  window.innerWidth / window.innerHeight,
  0.1,
  2000
);
camera.position.set(10, 6, 14);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

/* === TEXTURES === */
const loader = new THREE.TextureLoader();
const sunTex = loader.load("models/sunTex.png");
const earthTex = loader.load("models/earthTex.png");
const moonTex = loader.load("models/moonTex.png");

/* === SUN === */
const sun = new THREE.Mesh(
  new THREE.SphereGeometry(2, 64, 64),
  new THREE.MeshBasicMaterial({ map: sunTex })
);
sun.position.set(0, 0, 0);
scene.add(sun);

/* === REAL SUN LIGHT (Directional parallel rays) === */
const sunlight = new THREE.DirectionalLight(0xffffff, 2.2);
sunlight.position.set(0, 0, 0);  // source center
sunlight.castShadow = true;

sunlight.shadow.mapSize.width = 4096;
sunlight.shadow.mapSize.height = 4096;
sunlight.shadow.camera.near = 1;
sunlight.shadow.camera.far = 200;
sunlight.shadow.radius = 5; // penumbra softness

scene.add(sunlight);

/* === EARTH === */
const earth = new THREE.Mesh(
  new THREE.SphereGeometry(1, 64, 64),
  new THREE.MeshStandardMaterial({ map: earthTex })
);
earth.castShadow = true;
earth.receiveShadow = true;
scene.add(earth);

/* === MOON === */
const moon = new THREE.Mesh(
  new THREE.SphereGeometry(0.4, 64, 64),
  new THREE.MeshStandardMaterial({ map: moonTex })
);
moon.castShadow = true;
moon.receiveShadow = true;
scene.add(moon);

/* Earth receives moon shadow (solar eclipse) */
earth.receiveShadow = true;
/* Moon receives earth shadow (lunar eclipse) */
moon.receiveShadow = true;

/* sunlight target dynamically updated */
sunlight.target = earth;

/* === STARS TWINKLE === */
const starGeo = new THREE.BufferGeometry();
const starCount = 2000;
const starPositions = new Float32Array(starCount * 3);
const starOpacities = new Float32Array(starCount);

for (let i = 0; i < starCount; i++) {
  starPositions[i*3+0] = (Math.random()-0.5) * 500;
  starPositions[i*3+1] = (Math.random()-0.5) * 500;
  starPositions[i*3+2] = (Math.random()-0.5) * 500;
  starOpacities[i] = Math.random();
}

starGeo.setAttribute("position", new THREE.BufferAttribute(starPositions, 3));
starGeo.setAttribute("alpha", new THREE.BufferAttribute(starOpacities, 1));

const starMat = new THREE.PointsMaterial({
  color: 0xffffff,
  size: 1,
  transparent: true,
  opacity: 0.8,
  depthWrite: false
});

const stars = new THREE.Points(starGeo, starMat);
scene.add(stars);

/* === ANIMATION VARIABLES === */
let baseEarth = 0.0004;
let baseMoon  = 0.003;

let timeEarth = 0;
let timeMoon  = 0;

let speedFactor = 1;
let direction = 1;

let angleDeg = 0;
let moonDist = 2;

/* === SLIDER HANDLER === */
const angleSlider = document.getElementById("angle");
const distSlider  = document.getElementById("moonDist");
const speedSlider = document.getElementById("speed");
const angleVal = document.getElementById("angleVal");
const distVal  = document.getElementById("distVal");
const speedVal = document.getElementById("speedVal");

angleSlider.oninput = () => {
  angleDeg = parseFloat(angleSlider.value);
  angleVal.innerText = angleDeg;
};
distSlider.oninput = () => {
  moonDist = parseFloat(distSlider.value);
  distVal.innerText = moonDist.toFixed(2);
};
speedSlider.oninput = () => {
  speedFactor = parseFloat(speedSlider.value);
  speedVal.innerText = speedFactor;
};

/* === TOP BUTTONS === */
document.getElementById("btnPlay").onclick = () => direction = 1;
document.getElementById("btnStop").onclick = () => direction = 0;
document.getElementById("btnReverse").onclick = () => direction = -1;

/* === RESET === */
document.getElementById("reset").onclick = () => {
  angleSlider.value = 0;
  distSlider.value = 2;
  speedSlider.value = 1;

  angleDeg = 0;
  moonDist = 2;
  speedFactor = 1;
  direction = 1;

  angleVal.innerText = "0";
  distVal.innerText = "2.0";
  speedVal.innerText = "1";
};

/* === ANIMATE === */
function animate() {
  requestAnimationFrame(animate);

  timeEarth += baseEarth * speedFactor * direction;
  timeMoon  += baseMoon  * speedFactor * direction;

  const t = timeEarth;
  const m = timeMoon;

  const angle = angleDeg * Math.PI / 180;

  /* === EARTH ORBIT === */
  earth.position.set(
    Math.cos(t) * 6,
    Math.sin(angle) * 1.2,
    Math.sin(t) * 6
  );

  /* === MOON ORBIT === */
  moon.position.set(
    earth.position.x + Math.cos(m) * moonDist,
    earth.position.y + Math.sin(angle) * 0.5,
    earth.position.z + Math.sin(m) * moonDist
  );

  /* === REALISTIC SHADOW DIRECTION === */
  sunlight.target.position.copy(earth.position);

  /* === STAR TWINKLE === */
  const tStar = Date.now() * 0.002;
  starMat.opacity = 0.7 + Math.sin(tStar) * 0.25;

  earth.rotation.y += 0.01;
  moon.rotation.y += 0.014;

  controls.update();
  renderer.render(scene, camera);
}

animate();

/* === RESIZE === */
window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

</script>
</body>
</html>